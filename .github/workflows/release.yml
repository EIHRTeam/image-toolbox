name: Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (eg. v1.2.3)'
        required: true
        default: ''

# 修正点 1：添加 workflows: write 权限以解决报错
permissions:
  contents: write
  workflows: write

jobs:
  build-and-release-windows:
    runs-on: windows-latest
    name: Build Windows (x64) and Create Release

    env:
      CARGO_HOME: ${{ github.workspace }}\.cargo
      RUSTUP_HOME: ${{ github.workspace }}\.rustup

    steps:
      - name: Checkout repository (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CARGO_HOME }}/registry
            ${{ env.CARGO_HOME }}/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend (vite)
        run: npm run build

      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install WiX Toolset (needed for MSI bundling)
        run: |
          choco install wixtoolset --yes
          refreshenv || true

      - name: Build Tauri (bundle for Windows x64)
        run: |
          echo "Running tauri build..."
          npm run tauri build
        env:
          CI: true

      # 修正点 2：在构建后再处理 Tag，确保构建成功才打 Tag
      - name: Ensure tag exists (create & push if missing)
        id: ensure_tag
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.tag }}"
          if (-not $tag) {
            Write-Error "Tag input is required"
            exit 1
          }

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git fetch --tags origin
          # 使用更稳健的方式检查本地或远程是否存在 tag
          $tagExists = git tag -l $tag
          if (-not $tagExists) {
             $remoteTag = git ls-remote --tags origin refs/tags/$tag
             if ($remoteTag) { $tagExists = $true }
          }

          if (-not $tagExists) {
            Write-Host "Tag $tag not found. Creating and pushing..."
            git tag -a $tag -m "Release $tag"
            git push origin $tag
            Write-Host "Created and pushed tag $tag"
          } else {
            Write-Host "Tag $tag already exists."
          }

      - name: Read release message
        id: read_release_message
        shell: pwsh
        run: |
          if (Test-Path ".github/release-message.md") {
            $body = Get-Content -Raw .github/release-message.md
          } else {
            $body = "Release ${{ github.event.inputs.tag }}"
          }
          # 处理多行文本输出到 GITHUB_OUTPUT 的正确格式
          $delimiter = "EOF-$(Get-Random)"
          "body<<$delimiter" >> $env:GITHUB_OUTPUT
          $body >> $env:GITHUB_OUTPUT
          "$delimiter" >> $env:GITHUB_OUTPUT

      # 修正点 3：使用 softprops/action-gh-release 替代旧的 create-release 和手动上传脚本
      # 它会自动处理创建 Release 并在其中上传匹配到的文件
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.tag }}
          body: ${{ steps.read_release_message.outputs.body }}
          draft: false
          prerelease: false
          # 支持通配符，无需编写 PowerShell 循环上传
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/*.exe
            dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
